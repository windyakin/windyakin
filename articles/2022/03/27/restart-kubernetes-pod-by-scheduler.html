<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <title>Kubernetes の Pod を定期的に再起動させる</title>

    <meta name="description" content="windyakin&#39;s profile and portfolio site." />

    <meta property="og:title" content="Kubernetes の Pod を定期的に再起動させる" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://windyakin.net/articles/2022/03/27/restart-kubernetes-pod-by-scheduler.html" />
    <meta property="og:image" content="https://windyakin.net/img/ogp.png" />
    <meta property="og:description" content="windyakin&#39;s profile and portfolio site." />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@MITLicense" />
    <meta name="twitter:creator" content="@MITLicense" />
    <meta name="twitter:title" content="Kubernetes の Pod を定期的に再起動させる" />
    <meta name="twitter:image" content="https://windyakin.net/img/ogp.png" />
    <meta name="twitter:description" content="windyakin&#39;s profile and portfolio site." />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha512-NhSC1YmyruXifcj/KFRWoC561YpHpc5Jtzgvbuzx5VozKpWvQ+4nXhPdFgmx8xqexRcpAglTj9sIBWINXa8x5w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/css/bootstrap-grid.min.css" integrity="sha512-JQksK36WdRekVrvdxNyV3B0Q1huqbTkIQNbz1dlcFVgNynEMRl0F8OSqOGdVppLUDIvsOejhr/W5L3G/b3J+8w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism-themes/1.9.0/prism-ghcolors.min.css" integrity="sha512-8IZwRS36BrHutOtXP+S9ZLe/5MubhjJ26t1Kf9RYRt2kQi7brb8mLAKuJDX3qPJZ2U4Wg1cLPigCQVAxscTjtA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/open-sans-all@0.1.3/css/open-sans.min.css" integrity="sha256-wgnFwa6HsOY7SkI0IyMuzVeCe1qXdWyFp97C9tknq/U=" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <link rel="stylesheet" href="/css/base.css" />
    <link rel="stylesheet" href="/css/article.css" />
  </head>
  <body>
    <header>
      <h1><a href="/">windyakin.net</a></h1>
    </header>

    <div class="container">
  <div class="row justify-content-lg-center">
    <main class="col-12 col-lg-8 col-xl-6 order-lg-last">
      <article>
        <div class="article-header">
          <time datetime="2022-03-27">2022-03-27</time>
          <ul class="tags" aria-hidden="true">
            
            <li>
              
              <a href="/tags/Kubernetes.html" class="tags-item">Kubernetes</a>
            </li>
            
          </ul>
        </div>
        <h2 class="article-title">Kubernetes の Pod を定期的に再起動させる</h2>
        <h3 id="%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8%E3%81%AE%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3%E7%AE%A1%E7%90%86%E9%9D%A2%E5%80%92%E3%81%8F%E3%81%95%E3%81%84%E5%95%8F%E9%A1%8C%E3%82%92%E5%AE%9A%E6%9C%9F%E7%9A%84%E3%81%AA%E5%86%8D%E8%B5%B7%E5%8B%95%E3%81%A7%E8%A7%A3%E6%B1%BA%E3%81%99%E3%82%8B" tabindex="-1"><a class="anchor-link" href="#%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8%E3%81%AE%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3%E7%AE%A1%E7%90%86%E9%9D%A2%E5%80%92%E3%81%8F%E3%81%95%E3%81%84%E5%95%8F%E9%A1%8C%E3%82%92%E5%AE%9A%E6%9C%9F%E7%9A%84%E3%81%AA%E5%86%8D%E8%B5%B7%E5%8B%95%E3%81%A7%E8%A7%A3%E6%B1%BA%E3%81%99%E3%82%8B" aria-hidden="true">#</a> イメージのバージョン管理面倒くさい問題を定期的な再起動で解決する</h3>
<p>前回のエントリで <a href="https://windyakin.hateblo.jp/entry/2022/03/17/212009">k3s を運用している話</a>を書いたが、 GitOps 運用の中で私はコンテナの Docker イメージのバージョン管理をサボっている。現状各アプリケーションのイメージはすべて <code>latest</code> のタグが振られているのみで、イメージを更新しても GitOps に使っている manifests のリポジトリを更新される仕組みも用意していない。</p>
<p>だけどもこれだと Pod が生きている限りイメージが更新されても Pod が使うイメージが変わらないままになっていまうので、 CronJob を使って Deployment で起動している Pod を定期的に再起動している。これに併せて <code>imagePullPolicy: Always</code> を指定しておけば、 Pod の再起動の度に最新のイメージを取ってくることができるという目論見である。</p>
<h3 id="serviceaccount-%E3%82%92%E7%94%A8%E6%84%8F%E3%81%99%E3%82%8B" tabindex="-1"><a class="anchor-link" href="#serviceaccount-%E3%82%92%E7%94%A8%E6%84%8F%E3%81%99%E3%82%8B" aria-hidden="true">#</a> ServiceAccount を用意する</h3>
<p>ServiceAccount と (Cluster)Role と (Cluster)RoleBinding を用意する。自分は最初この3者の関係がよくわかっていなかったのだが、色々調べていくうちにでいうと Role と ServiceAccount の多対多の関係を表現する中間テーブルが RoleBinding であると理解した。要は Google の IAM 管理で行う「権限」のグループを作ってその権限をユーザに割り当てる行為と同じである。また Role / RoleBinding の頭に Cluster がついて ClusterRole や ClusterRoleBinding になると、その権限は namespace を超えて実行することができる。</p>
<p>まずは Role について。最終的に ServiceAccount が使えるようになる Kubernetes API を一覧にする。 kubectl コマンドで <code>kubectl [verbs] [resources]</code> が使えるようになるという理解が近い。ここに <code>apiGroups</code> という概念も登場する。 Pod は <code>apiVersion: v1</code> と表現されるが、この場合はコア機能であるので <code>&quot;&quot;</code> (空文字) が指定される。一方 Deployment は <code>apiVersion: apps/v1</code> と指定するため <code>apps</code> を指定することになる。</p>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole<br><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<br><span class="token key atrule">metadata</span><span class="token punctuation">:</span><br>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>restarter<br><span class="token key atrule">rules</span><span class="token punctuation">:</span><br>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span><br>      <span class="token punctuation">-</span> <span class="token string">""</span><br>    <span class="token key atrule">resources</span><span class="token punctuation">:</span><br>      <span class="token punctuation">-</span> pods<br>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span><br>      <span class="token punctuation">-</span> get<br>      <span class="token punctuation">-</span> list<br>      <span class="token punctuation">-</span> delete<br>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span><br>      <span class="token punctuation">-</span> apps<br>    <span class="token key atrule">resources</span><span class="token punctuation">:</span><br>      <span class="token punctuation">-</span> deployments<br>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span><br>      <span class="token punctuation">-</span> get<br>      <span class="token punctuation">-</span> list</code></pre>
<p>次に ServiceAccount。特に凝ったことはしないのでそのまま名前をつけるだけ。</p>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<br><span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount<br><span class="token key atrule">metadata</span><span class="token punctuation">:</span><br>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>restarter</code></pre>
<p>最後に Role と ServiceAccount を紐付ける RoleBinding を記述する。</p>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding<br><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<br><span class="token key atrule">metadata</span><span class="token punctuation">:</span><br>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>restarter<br><span class="token key atrule">subjects</span><span class="token punctuation">:</span><br>  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount<br>    <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>restarter<br>    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<br><span class="token key atrule">roleRef</span><span class="token punctuation">:</span><br>  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole<br>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>restarter<br>  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io</code></pre>
<h3 id="cronjob-%E3%82%92%E7%94%A8%E6%84%8F%E3%81%99%E3%82%8B" tabindex="-1"><a class="anchor-link" href="#cronjob-%E3%82%92%E7%94%A8%E6%84%8F%E3%81%99%E3%82%8B" aria-hidden="true">#</a> CronJob を用意する</h3>
<p>Pod を再起動させる方法は色々なあるが、 <code>delete pods</code> を定期的に実行されるようにした。これだとダウンタイムが出るが、自分が使うサービスなのでこのままにする。おそらく通常は Deployments の annotate に日付を入れると manifests の更新とともに Pod が再作成されるという方法をとることになるが、自分の環境は ArgoCD で即刻上書きされるので向いていないためこうした。</p>
<p><a href="https://hub.docker.com/r/bitnami/kubectl">bitnami/kubectl</a> のイメージ上から kubetl の <code>jsonpath</code> で Deployment の名前の一覧のみを出力し、その結果を xargs にパイプして <code>delete pods</code> を実行させるようにしている。</p>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1<br><span class="token key atrule">kind</span><span class="token punctuation">:</span> CronJob<br><span class="token key atrule">metadata</span><span class="token punctuation">:</span><br>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>restarter<br><span class="token key atrule">spec</span><span class="token punctuation">:</span><br>  <span class="token key atrule">schedule</span><span class="token punctuation">:</span> <span class="token string">"0 2 * * *"</span><br>  <span class="token key atrule">concurrencyPolicy</span><span class="token punctuation">:</span> Replace<br>  <span class="token key atrule">jobTemplate</span><span class="token punctuation">:</span><br>    <span class="token key atrule">spec</span><span class="token punctuation">:</span><br>      <span class="token key atrule">template</span><span class="token punctuation">:</span><br>        <span class="token key atrule">spec</span><span class="token punctuation">:</span><br>          <span class="token key atrule">serviceAccount</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>restarter<br>          <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never<br>          <span class="token key atrule">containers</span><span class="token punctuation">:</span><br>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>restarter<br>              <span class="token key atrule">image</span><span class="token punctuation">:</span> bitnami/kubectl<span class="token punctuation">:</span>latest<br>              <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">]</span><br>              <span class="token key atrule">args</span><span class="token punctuation">:</span><br>                <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string"><br>                  kubectl get deployments -o=jsonpath='{range .items[*]}{.spec.template.metadata.labels.app}{"\n"}{end}' | xargs -I "{}" kubectl delete pods -l app={}</span></code></pre>
<h3 id="%E5%8A%B9%E6%9E%9C" tabindex="-1"><a class="anchor-link" href="#%E5%8A%B9%E6%9E%9C" aria-hidden="true">#</a> 効果</h3>
<p>いまのところ毎日深夜2時に再起動がかかる運用になっており、最長1日待てば最新のイメージが落とされるようになっている。普段は依存パッケージのセキュリティ更新しかしないためこの運用で問題なく感じている。</p>
<p>ただここまで紹介したのは結構な面倒くさがりの所業で、一般公開しているサービスなどでこれをするのは非常におすすめしない。一旦はこれで運用ができているのはあくまで個人の管理しているサービスだからである。</p>

      </article>
    </main>
    <aside class="col-12 col-lg-4 col-xl-3 order-lg-first mt-5 mt-lg-0">
      <div class="profile">
  <div class="profile-image">
    <img src="/img/profile.jpg" alt="windyakin" />
  </div>

  <section>
    <h2>Profile</h2>
    <dl>
      <div>
        <dt>Name</dt>
        <dd>
          <ul class="inline-list">
            <li lang="en">KANZAKI Takuto</li><li lang="ja">神﨑 拓人</li>
          </ul>
        </dd>
      </div>
      <div>
        <dt>Screen name</dt>
        <dd>
          <ul class="inline-list">
            <li>windyakin</li><li>じゅりあん</li>
          </ul>
        </dd>
      </div>
    </dl>
  </section>

  <section>
    <h2>Organization</h2>
    <dl>
      <div>
        <dt><a href="https://pepabo.com">GMO Pepabo, Inc.</a></dt>
        <dd>Senior Engineer</dd>
      </div>
      <div>
        <dt><a href="https://napple.team/">Napple Team</a></dt>
        <dd>Organizer</dd>
      </div>
    </dl>
  </section>

  <section>
    <h2>Contact / Link</h2>
    <dl>
      <div>
        <dt>E-mail</dt>
        <dd><a href="mailto:windyakin@napple.team">windyakin@napple.team</a></dd>
      </div>
      <div>
        <dt>Twitter</dt>
        <dd><a href="https://twitter.com/MITLicense">twitter.com/MITLicense</a></dd>
      </div>
      <div>
        <dt>GitHub</dt>
        <dd><a href="https://github.com/windyakin">github.com/windyakin</a></dd>
      </div>
      <div>
        <dt>Tumblr</dt>
        <dd><a href="https://windyakin.tumblr.com/">windyakin.tumblr.com</a></dd>
      </div>
      <div>
        <dt>Facebook</dt>
        <dd><a href="https://www.facebook.com/windyakin">facebook.com/windyakin</a></dd>
      </div>
      <div>
        <dt>Vimeo</dt>
        <dd><a href="https://vimeo.com/windyakin">vimeo.com/windyakin</a></dd>
      </div>
    </dl>
  </section>
</div>

    </aside>
  </div>
</div>


    <footer>
      © 2020 windyakin
    </footer>
  </body>
</html>
