<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <title>k3s を運用している</title>

    <meta name="description" content="windyakin&#39;s profile and portfolio site." />

    <meta property="og:title" content="k3s を運用している" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://windyakin.net/articles/2022/03/17/operating-k3s.html" />
    <meta property="og:image" content="https://windyakin.net/img/ogp.png" />
    <meta property="og:description" content="windyakin&#39;s profile and portfolio site." />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@MITLicense" />
    <meta name="twitter:creator" content="@MITLicense" />
    <meta name="twitter:title" content="k3s を運用している" />
    <meta name="twitter:image" content="https://windyakin.net/img/ogp.png" />
    <meta name="twitter:description" content="windyakin&#39;s profile and portfolio site." />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha512-NhSC1YmyruXifcj/KFRWoC561YpHpc5Jtzgvbuzx5VozKpWvQ+4nXhPdFgmx8xqexRcpAglTj9sIBWINXa8x5w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/css/bootstrap-grid.min.css" integrity="sha512-JQksK36WdRekVrvdxNyV3B0Q1huqbTkIQNbz1dlcFVgNynEMRl0F8OSqOGdVppLUDIvsOejhr/W5L3G/b3J+8w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism-themes/1.9.0/prism-ghcolors.min.css" integrity="sha512-8IZwRS36BrHutOtXP+S9ZLe/5MubhjJ26t1Kf9RYRt2kQi7brb8mLAKuJDX3qPJZ2U4Wg1cLPigCQVAxscTjtA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
      *,::after,::before{box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji"}header{text-align:center;margin:0;padding:5rem 0}header>h1>a{text-decoration:none;color:#000}.content{padding:.5rem 0}.profile{text-align:center;font-size:14px}.profile-image{position:relative;width:160px;height:160px;margin:auto;border-radius:50%;overflow:hidden}.profile-image>img{width:160px;height:160px}.profile section{margin-bottom:2rem}.profile dl>div{margin-bottom:.8rem}.profile dl dt{margin-bottom:.2rem;font-size:.95rem}.profile dl dd{margin:0}.profile ul{list-style:none;margin:0;padding:0}.profile ul.inline-list>li{display:inline-block}.profile ul.inline-list>li:not(:last-child)::after{content:'/';margin:auto .2rem}footer{margin:0;padding:2rem 0;text-align:center}
      .articles{list-style:none;padding:0}.articles .articles-item{margin-top:1.5rem;margin-bottom:.5}.article-header{display:inline-flex}.article-header>time{margin-right:.8rem}ul.tags{display:inline-flex;margin:0;padding:0;list-style:none}ul.tags>li{display:inline-block;margin:0}.tags .tags-item{display:inline-block;margin:0;padding:0 .5rem 0 0;font-size:.85em}.tags .tags-item::before{content:'#'}.article-title{margin-top:.5rem;line-height:1.2}.more{margin:2rem auto 1rem auto}.more ul{list-style:none;padding:0}.pagination{margin:2rem auto 1rem auto}.pagination-list{list-style:none;padding:0}.pagination-list-item{padding:.5rem}article{line-height:1.5}article h1,article h2,article h3,article h4,article h5{line-height:1.2}article ul{padding-left:1.2em}article ul li{margin-top:.25em}a.anchor-link{color:#888;text-decoration:none}article code{font-family:ui-monospace,SFMono-Regular,SF Mono,Menlo,Consolas,Liberation Mono,monospace!important;font-size:85%!important}article code:not([class*=language-]){padding:.2em .4em;margin:0;white-space:break-spaces;background-color:rgba(175,184,193,.2);border-radius:6px}.responsive-img{max-width:100%;height:auto}
    </style>
  </head>
  <body>
    <header>
      <h1><a href="/">windyakin.net</a></h1>
    </header>

    <div class="content">
      <div class="container">
  <div class="row justify-content-lg-center">
    <main class="col-12 col-lg-8 col-xl-6 order-lg-last">
      <article class="article-body">
        <div class="article-header">
          <time datetime="2022-03-17">2022-03-17</time>
          <ul class="tags" aria-hidden="true">
            
            <li>
              
              <a href="/tags/Kubernetes.html" class="tags-item">Kubernetes</a>
            </li>
            
          </ul>
        </div>
        <h2 class="article-title">k3s を運用している</h2>
        <p>個人的なプロジェクトを外部公開するときや、私的なツール郡を動かすためにVPSを借りている。基本的に自分が作ったサービスたちはコンテナ化されているため、それらのコンテナの起動管理についてはこれまで docker-compose を使っていた。しかし業務で Kubernetes を使う機会が多くなり、コンテナや Kubernetes の運用に関するいろいろな知見も溜まってきたので、自前で Kubernetes のクラスタが欲しくなったのだが、趣味にしては維持費が高い。正直そこまで可用性が必要もないが、 ArgoCD で GitOps による自動デプロイとかそういう楽なことだけはしたいという欲が湧いてきたので、 k3s をつかってシングルノードの Kubernetes を運用することにした。この記事ではその際どういったことをしたかなどをまとめる。</p>
<h3 id="k3s-%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB" tabindex="-1"><a class="anchor-link" href="#k3s-%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB" aria-hidden="true">#</a> k3s のインストール</h3>
<p>おもむろに k3s をいれるが、ワン・コマンドで入れられるので便利。なんならアップグレードもこれでできるのですごい。</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token function">sh</span> -</code></pre>
<p>ただしこのままだと <code>kubectl</code> を叩く度に <code>sudo</code> が必要になるので面倒。もう少しよしなにしたい。 Linuxbrew で入れた <code>kubectl</code> で使えるようにするために、 <code>~/.kube/config</code> に接続設定を含めて出せばいちいち <code>sudo</code> しなくてもよくなる（セキュリティはパーミッションなど最低限のことはやったほうがよい）。</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">sudo</span> kubectl config view <span class="token parameter variable">--raw</span> <span class="token operator">></span> ~/.kube/config</code></pre>
<h3 id="sealedsecret" tabindex="-1"><a class="anchor-link" href="#sealedsecret" aria-hidden="true">#</a> SealedSecret</h3>
<p>Git で Kubernetes の Manifests を管理するとき、 Secret をそのままコミットすると危険なのだが、 SealedSecret を使うことで暗号化した状態にできる。暗号化を行うために一度クラスタに Secret を読み込ませる必要があったり、情報の更新が若干面倒というデメリットもあるが、そのあたりは GitOps したい度とのトレードオフだろう。</p>
<pre class="language-bash"><code class="language-bash">kubectl apply <span class="token parameter variable">-f</span> https://github.com/bitnami-labs/sealed-secrets/releases/download/<span class="token variable">${VERSION}</span>/controller.yaml</code></pre>
<p><code>${VERSION}</code> は SealedSecret のリポジトリの最新を使うとよい。</p>
<p>Secret 情報の暗号化は <code>kubeseal</code> コマンドを使って行う。Secret の manifests が用意できていれば以下のようなコマンドを実行する。</p>
<pre class="language-bash"><code class="language-bash">kubeseal <span class="token parameter variable">--scope</span> namespace-wide <span class="token parameter variable">-o</span> yaml <span class="token operator">&lt;</span> secret.yaml <span class="token operator">></span> sealedsecret.yaml</code></pre>
<h3 id="argocd" tabindex="-1"><a class="anchor-link" href="#argocd" aria-hidden="true">#</a> ArgoCD</h3>
<p>GitOps のために ArgoCD を入れる。 core-install.yaml はコア機能のみで Web UI などはインストールされない。</p>
<pre class="language-bash"><code class="language-bash">kubectl create namespace argocd<br>kubectl apply <span class="token parameter variable">-n</span> argocd <span class="token parameter variable">-f</span> https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/core-install.yaml</code></pre>
<p>初めて触れるなら Web UI はあったほうがよさそうに思う。リソースの管理がどういうものかとか、更新のタイミングなども見ることができるので面白い。</p>
<p>ArgoCD の使い方は公式のドキュメントが一番くわしい。</p>
<p><a href="https://argo-cd.readthedocs.io/en/stable/getting_started/">Getting Started - Argo CD - Declarative GitOps CD for Kubernetes</a></p>
<p>CLI で操作する場合は <code>argocd</code> コマンドなどを導入すると GitOps につかうリポジトリの登録や、実際のアプリケーションの設定などがコマンドからできて便利。</p>
<pre class="language-bash"><code class="language-bash">argocd repo <span class="token function">add</span> git@github.com:windyakin/k8s-manifests.git --ssh-private-key-path <span class="token variable">${SSH_PRIVATE_KEY_PATH}</span></code></pre>
<pre class="language-bash"><code class="language-bash">argocd app create argocd-applications <span class="token punctuation">\</span><br>  <span class="token parameter variable">--repo</span> git@github.com:windyakin/k8s-manifests.git <span class="token punctuation">\</span><br>  <span class="token parameter variable">--path</span> argocd-application <span class="token punctuation">\</span><br>  --auto-prune <span class="token punctuation">\</span><br>  --dest-namespace default <span class="token punctuation">\</span><br>  --dest-server https://kubernetes.default.svc <span class="token punctuation">\</span><br>  <span class="token parameter variable">--revision</span> HEAD</code></pre>
<h3 id="k3s-%E9%81%8B%E7%94%A8%E3%81%97%E3%81%A6%E3%81%BF%E3%81%A6%E3%81%A9%E3%81%86%E3%81%8B" tabindex="-1"><a class="anchor-link" href="#k3s-%E9%81%8B%E7%94%A8%E3%81%97%E3%81%A6%E3%81%BF%E3%81%A6%E3%81%A9%E3%81%86%E3%81%8B" aria-hidden="true">#</a> k3s 運用してみてどうか</h3>
<p>もともとは microk8s を導入していたのだが、どういうわけか liveness probe を入れたあたりから Kubernetes  の API が重くなってしまい、 kubectl すらまともに使えなくなってしまったため、 k3s に乗り換えたという経緯があった。 コンテナを立てて運用する程度であれば k3s の機能でも十分であり、 microk8s に比べるとオーバーヘッドも少なく助かっているところではある。</p>
<p>またもともとやりたかった GitOps による運用ができたのも楽でよい。基本的にほったらかしで、監視等も入れていないのだが、不自然な挙動などはなく正常にうごいている。ただ貧弱なサーバーのシングルノードなので可用性の向上や、スケーリングといった恩恵は受けることは出来ない。 Kubernetes の美味しいところを知っていてそれにあやかりたい場合は、趣味の割り切りとして使ってよいのではないだろうか。</p>

      </article>
    </main>
    <aside class="col-12 col-lg-4 col-xl-3 order-lg-first mt-5 mt-lg-0">
      <div class="profile">
  <div class="profile-image">
    <img src="/img/profile.jpg" alt="windyakin" />
  </div>

  <section>
    <h2>Profile</h2>
    <dl>
      <div>
        <dt>Name</dt>
        <dd>
          <ul class="inline-list">
            <li lang="en">KANZAKI Takuto</li><li lang="ja">神﨑 拓人</li>
          </ul>
        </dd>
      </div>
      <div>
        <dt>Screen name</dt>
        <dd>
          <ul class="inline-list">
            <li>windyakin</li><li>じゅりあん</li>
          </ul>
        </dd>
      </div>
    </dl>
  </section>

  <section>
    <h2>Organization</h2>
    <dl>
      <div>
        <dt><a href="https://pepabo.com">GMO Pepabo, Inc.</a></dt>
        <dd>Senior Engineer</dd>
      </div>
      <div>
        <dt><a href="https://napple.team/">Napple Team</a></dt>
        <dd>Organizer</dd>
      </div>
    </dl>
  </section>

  <section>
    <h2>Contact / Link</h2>
    <dl>
      <div>
        <dt>E-mail</dt>
        <dd><a href="mailto:windyakin@napple.team">windyakin@napple.team</a></dd>
      </div>
      <div>
        <dt>Twitter</dt>
        <dd><a href="https://twitter.com/MITLicense">twitter.com/MITLicense</a></dd>
      </div>
      <div>
        <dt>GitHub</dt>
        <dd><a href="https://github.com/windyakin">github.com/windyakin</a></dd>
      </div>
      <div>
        <dt>Tumblr</dt>
        <dd><a href="https://windyakin.tumblr.com/">windyakin.tumblr.com</a></dd>
      </div>
      <div>
        <dt>Facebook</dt>
        <dd><a href="https://www.facebook.com/windyakin">facebook.com/windyakin</a></dd>
      </div>
      <div>
        <dt>Vimeo</dt>
        <dd><a href="https://vimeo.com/windyakin">vimeo.com/windyakin</a></dd>
      </div>
    </dl>
  </section>
</div>

    </aside>
  </div>
</div>

    </div>

    <footer>
      © 2020 windyakin
    </footer>
  </body>
</html>
