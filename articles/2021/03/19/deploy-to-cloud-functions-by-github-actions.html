<!doctype html><html lang="ja"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>GitHub Actions をつかって Google Cloud Functions にデプロイする</title><meta name="description" content="windyakin&#39;s profile and portfolio site."><meta property="og:title" content="GitHub Actions をつかって Google Cloud Functions にデプロイする"><meta property="og:type" content="website"><meta property="og:url" content="https://windyakin.net/articles/2021/03/19/deploy-to-cloud-functions-by-github-actions.html"><meta property="og:image" content="https://windyakin.net/img/ogp.png"><meta property="og:description" content="windyakin&#39;s profile and portfolio site."><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@MITLicense"><meta name="twitter:creator" content="@MITLicense"><meta name="twitter:title" content="GitHub Actions をつかって Google Cloud Functions にデプロイする"><meta name="twitter:image" content="https://windyakin.net/img/ogp.png"><meta name="twitter:description" content="windyakin&#39;s profile and portfolio site."><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha512-NhSC1YmyruXifcj/KFRWoC561YpHpc5Jtzgvbuzx5VozKpWvQ+4nXhPdFgmx8xqexRcpAglTj9sIBWINXa8x5w==" crossorigin="anonymous" referrerpolicy="no-referrer"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/css/bootstrap-grid.min.css" integrity="sha512-JQksK36WdRekVrvdxNyV3B0Q1huqbTkIQNbz1dlcFVgNynEMRl0F8OSqOGdVppLUDIvsOejhr/W5L3G/b3J+8w==" crossorigin="anonymous" referrerpolicy="no-referrer"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism-themes/1.9.0/prism-ghcolors.min.css" integrity="sha512-8IZwRS36BrHutOtXP+S9ZLe/5MubhjJ26t1Kf9RYRt2kQi7brb8mLAKuJDX3qPJZ2U4Wg1cLPigCQVAxscTjtA==" crossorigin="anonymous" referrerpolicy="no-referrer"><style>*,::after,::before{box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji";line-height:1.5}article h1,article h2,article h3,article h4,article h5{line-height:1.2}ul{padding-left:1.2em;margin-top:.3em;padding-bottom:.3em}ul li{margin-top:.15em;margin-bottom:.15em}header{text-align:center;margin:0;padding:5rem 0}header>h1>a{text-decoration:none;color:#000}.content{padding:.5rem 0}.profile{text-align:center;font-size:14px;line-height:1.2}.profile-image{position:relative;width:160px;height:160px;margin:auto;border-radius:50%;overflow:hidden}.profile-image>img{width:160px;height:160px}.profile section{margin-bottom:2rem}.profile dl>div{margin-bottom:.8rem}.profile dl dt{margin-bottom:.2rem;font-size:.95rem}.profile dl dd{margin:0}.profile ul{list-style:none;margin:0;padding:0}.profile ul.inline-list>li{display:inline-block}.profile ul.inline-list>li:not(:last-child)::after{content:'/';margin:auto .2rem}footer{margin:0;padding:2rem 0;text-align:center}
      .articles{list-style:none;padding:0}.articles .articles-item{margin-top:1.5rem;margin-bottom:.5}.article-header{display:inline-flex}.article-header>time{margin-right:.8rem}ul.tags{display:inline-flex;margin:0;padding:0;list-style:none}ul.tags>li{display:inline-block;margin:0}.tags .tags-item{display:inline-block;margin:0;padding:0 .5rem 0 0;font-size:.85em}.tags a.tags-item::before{content:'#'}.article-title{margin-top:.5rem;line-height:1.2}.more{margin:2rem auto 1rem auto}.more ul{list-style:none;padding:0}.pagination{margin:2rem auto 1rem auto}.pagination-list{list-style:none;padding:0}.pagination-list-item{padding:.5rem}a.anchor-link{color:#888;text-decoration:none}article code{font-family:ui-monospace,SFMono-Regular,SF Mono,Menlo,Consolas,Liberation Mono,monospace!important;font-size:85%!important}article code:not([class*=language-]){padding:.2em .4em;margin:0;white-space:break-spaces;background-color:rgba(175,184,193,.2);border-radius:6px}article blockquote{margin:1.5rem 0;padding-left:1.5rem;border-left:4px solid #ccc}article blockquote p{margin:0}article blockquote footer{margin:.5rem 0 0 0;padding:0;text-align:right}article blockquote footer cite{font-size:.85em;color:#666}.responsive-img{max-width:100%;height:auto}article figure{margin:0}article figure figcaption{font-size:.85em;color:#666;text-align:center}</style></head><body><header><h1><a href="/">windyakin.net</a></h1></header><div class="content"><div class="container"><div class="row justify-content-lg-center"><main class="col-12 col-lg-8 col-xl-6 order-lg-last"><article class="article-body"><div class="article-header"><time datetime="2021-03-19">2021-03-19</time><ul class="tags" aria-hidden="true"><li><a href="/tags/Tips.html" class="tags-item">Tips</a></li></ul></div><h2 class="article-title">GitHub Actions をつかって Google Cloud Functions にデプロイする</h2><p></p><figure><picture><source type="image/webp" srcset="/img/optimized/xlxSoB3cOn-1200.webp 1200w"><img class="responsive-img" decoding="async" alt="" src="/img/optimized/xlxSoB3cOn-1200.jpeg" width="1200" height="675"></picture></figure><p></p><p>Google Cloud Functions ってやつ、 Slack の Webhook 系のアクションだとか、情報を整形して別の API に横流しするだけの Proxy 系アプリケーションなんかのホスト先として便利に使ってたのだけども、その簡単さからCDの構築をサボっていて、よくリポジトリの状態と実際に展開されているコードが違うみたいな状態のまま放置してしまうなどどうにもうまく管理ができていなかったんですよね。まあ先述の通りそんなに重要なアプリケーションを管理しているわけでもないので、長らく自分の中での「動いてるからいいや」の代表的な存在だったのですが、やっぱりCVEなんかで報告されているような脆弱性を抱えるライブラリをそのまま放置するのはよくないなという気持ちになり、重い腰を上げてCD環境を整備することにしたのでそのメモ。</p><h3 id="%E3%81%8A%E8%AA%82%E3%81%88%E5%90%91%E3%81%8D" tabindex="-1"><a class="anchor-link" href="#%E3%81%8A%E8%AA%82%E3%81%88%E5%90%91%E3%81%8D" aria-hidden="true">#</a> お誂え向き</h3><p>もともとソースコード管理のメインは GitHub のリポジトリで、そのリポジトリを GCP の Cloud Source Repository にミラーリングし Cloud Functions にポチポチしてデプロイするみたいなフローだったのだけども、いつからか Cloud Source Repository に自動で反映されなくなってしまい（調べてないがおそらく Webhook の設定がおかしいのだと思う）、直せばいいのだけど「面倒だな」と思って放置した結果、「面倒だな」の連鎖が発生してやる気を完全に削ぐ原因になっていた。で、「じゃあ GitHub Actions から直接 Cloud Functions にデプロイできねえのか」と思って探したらすんなり見つかったんだよね。さすが2021年。</p><p><a href="https://github.com/google-github-actions/deploy-cloud-functions">google-github-actions/deploy-cloud-functions: A GitHub Action that deploys source code to Google Cloud Functions.</a></p><p>「え〜 めちゃくちゃ便利じゃん〜」と思って早速使おうと思ったのだけど、なぜかリポジトリの Star が2021年3月時点で30個ぐらいしかついてなくて、 Organization の名前に「google」って入ってるけど非公式なの？と思って調べたのだけど、 People 欄に表示されている人が Google の公式 Organization にも所属しているのでおそらく大丈夫なのだろうと（本当に最近できた Org なのだと思う）。そんなわけで実際に使ってみることにしたわけ。</p><h3 id="%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%82%92%E4%BD%9C%E3%82%8B" tabindex="-1"><a class="anchor-link" href="#%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%82%92%E4%BD%9C%E3%82%8B" aria-hidden="true">#</a> サービスアカウントを作る</h3><p>Actions を実行するためには当然だが Cloud Functions にデプロイするためのサービスアカウントのキーが必要になる。GCPのアカウント権限周りの設定は毎度わからんという気持ちになるがこのような愚痴はグッと飲み込んで、プロジェクトの「IAM と管理」→「サービスアカウント」の画面から <code>cloudfunctions.serviceAgent</code> (Cloud Functions サービスエージェント) 権限を持つアカウントを作成してやる。その他の「条件」は必要であれば入れる。鍵が流出したときのリスクとかを制御できるのでそう考えると入れたほうがよいのは当然なのだが、使い回すにはいちいちアカウントつくったりしなきゃならんので個人管理のものであると面倒である。</p><p></p><figure><picture><source type="image/webp" srcset="/img/optimized/_bDPdsvy5L-1174.webp 1174w"><img class="responsive-img" decoding="async" alt="" src="/img/optimized/_bDPdsvy5L-1174.jpeg" width="1174" height="980"></picture></figure><p></p><p>そのままサービスアカウントのキーも作成してしまい、発行された JSON キーをそのまま GitHub リポジトリの Settings → Secrets へ登録するとよい。</p><p></p><figure><picture><source type="image/webp" srcset="/img/optimized/hsWX-xYD9w-1200.webp 1200w"><img class="responsive-img" decoding="async" alt="" src="/img/optimized/hsWX-xYD9w-1200.jpeg" width="1200" height="594"></picture></figure><p></p><h3 id="actions-%E3%81%AE%E3%82%B8%E3%83%A7%E3%83%96%E3%81%AB%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%81%99%E3%82%8B%E3%82%B9%E3%83%86%E3%83%83%E3%83%97%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B" tabindex="-1"><a class="anchor-link" href="#actions-%E3%81%AE%E3%82%B8%E3%83%A7%E3%83%96%E3%81%AB%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%81%99%E3%82%8B%E3%82%B9%E3%83%86%E3%83%83%E3%83%97%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B" aria-hidden="true">#</a> Actions のジョブにデプロイするステップを追加する</h3><p>このとき設定できる内容については <a href="https://github.com/google-github-actions/deploy-cloud-functions">google-github-actions/deploy-cloud-functions</a> の README を見れば全て書いてくれている。注意したい点としては環境変数を与えているのであればここで指定しておく必要があるということ。</p><pre class="language-yml"><code class="language-yml"><span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> deploy
  <span class="token key atrule">uses</span><span class="token punctuation">:</span> google<span class="token punctuation">-</span>github<span class="token punctuation">-</span>actions/deploy<span class="token punctuation">-</span>cloud<span class="token punctuation">-</span>functions@main
  <span class="token key atrule">with</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> clound<span class="token punctuation">-</span>functions<span class="token punctuation">-</span>application
    <span class="token key atrule">runtime</span><span class="token punctuation">:</span> nodejs12
    <span class="token key atrule">entry_point</span><span class="token punctuation">:</span> application
    <span class="token key atrule">credentials</span><span class="token punctuation">:</span> $
    <span class="token key atrule">env_vars</span><span class="token punctuation">:</span> <span class="token punctuation">></span><span class="token punctuation">-</span>
      SECRETS_ENVIRONMENT_1=$
      <span class="token punctuation">,</span>SECRETS_ENVIRONMENT_2=$</code></pre><p>たいてい秘匿情報とかがあるので Actions 側の Secrets に登録する羽目になる。複数ある場合なんかはカンマで繋げる必要があるが YAML のヒアドキュメントである <code>&gt;-</code> なんかを組み合わせて使うと改行できて便利。</p><h3 id="%E5%AE%9F%E9%9A%9B%E3%81%AB%E5%8B%95%E3%81%8B%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B" tabindex="-1"><a class="anchor-link" href="#%E5%AE%9F%E9%9A%9B%E3%81%AB%E5%8B%95%E3%81%8B%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B" aria-hidden="true">#</a> 実際に動かしてみる</h3><p>実際に Actions を動かしてみると、おお動くという感じになると思う。デプロイにはすこしだけ時間がかかるものの、 Actions 側はデプロイしたアプリケーションが適用されたことを確認できるまでポーリングするので Actions が終了したらデプロイが完了したものと思えば良さそう。</p><p></p><figure><picture><source type="image/webp" srcset="/img/optimized/5RyybLg857-1200.webp 1200w"><img class="responsive-img" decoding="async" alt="" src="/img/optimized/5RyybLg857-1200.jpeg" width="1200" height="675"></picture></figure><p></p><p>これで GitHub のリポジトリが Google にミラーリングされているかどうかを気にしたり、デプロイのためのポチポチ業から開放されたわけだ。便利。</p></article></main><aside class="col-12 col-lg-4 col-xl-3 order-lg-first mt-5 mt-lg-0"><div class="profile"><div class="profile-image"><img src="/img/profile.jpg" alt="windyakin"></div><section><h2>Profile</h2><dl><div><dt>Name</dt><dd><ul class="inline-list"><li lang="en">KANZAKI Takuto</li><li lang="ja">神﨑 拓人</li></ul></dd></div><div><dt>Screen name</dt><dd><ul class="inline-list"><li>windyakin</li><li>じゅりあん</li></ul></dd></div></dl><div><a href="/carrier/">職務経歴書</a></div></section><section><h2>Organization</h2><dl><div><dt><a href="https://pepabo.com">GMO Pepabo, Inc.</a></dt><dd>Senior Engineer</dd></div><div><dt><a href="https://umineco.org/">沼津移住者コミュニティ<br>うみねこ</a></dt><dd>Organizer</dd></div><div><dt><a href="https://napple.team/">Napple Team</a></dt><dd>Organizer</dd></div></dl></section><section><h2>Contact / Link</h2><dl><div><dt>E-mail</dt><dd><a href="mailto:windyakin@napple.team">windyakin@napple.team</a></dd></div><div><dt>Bluesky</dt><dd><a href="https://bsky.app/profile/windyakin.net">bsky.app/profile/@windyakin.net</a></dd></div><div><dt>GitHub</dt><dd><a href="https://github.com/windyakin">github.com/windyakin</a></dd></div><div><dt>Facebook</dt><dd><a href="https://www.facebook.com/windyakin">facebook.com/windyakin</a></dd></div><div><dt>Vimeo</dt><dd><a href="https://vimeo.com/windyakin">vimeo.com/windyakin</a></dd></div></dl></section></div></aside></div></div></div><footer>© 2020 windyakin</footer></body></html>